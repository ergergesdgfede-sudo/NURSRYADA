<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ - ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ…Ø±ÙŠØ¶</title>
    
    <meta property="og:title" content="Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø¯Ø© - ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ…Ø±ÙŠØ¶">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Outfit:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="face-api.min.js"></script>

    <style>
        /* === Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª === */
        #desktop-blocker { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; color: #ef4444; z-index: 99999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-family: 'Cairo'; }
        :root { --primary: #0ea5e9; --primary-dark: #0284c7; --text-main: #1e293b; --glass-bg: rgba(255, 255, 255, 0.95); }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html { background-color: #0f172a !important; height: 100vh; overflow-y: auto; overflow-x: hidden; }
        body { font-family: 'Cairo', sans-serif; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: transparent; padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px; }
        
        .bg-image { background: url('https://a.top4top.io/p_36115ao3o1.jpg') no-repeat center center; background-size: cover; filter: blur(12px) brightness(0.9); position: fixed; top: -10vh; left: -10vw; width: 120vw; height: 120vh; z-index: -1; }
        .app-card { background: var(--glass-bg); width: 100%; max-width: 400px; border-radius: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); overflow: hidden; position: relative; min-height: 600px; display: flex; flex-direction: column; }
        .section { display: none; animation: fadeIn 0.4s ease; flex: 1; padding: 20px; overflow-y: auto; }
        .section.active { display: block; }

        /* Buttons & Inputs */
        .btn-main { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; width: 100%; padding: 15px; border-radius: 16px; font-weight: 800; border: none; font-size: 16px; cursor: pointer; margin-top: 15px; font-family: 'Cairo'; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .modern-input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-family: 'Cairo'; font-size: 18px; text-align: center; margin-bottom: 15px; background: #f8fafc; font-weight: bold; }
        
        /* === ØªØµÙ…ÙŠÙ… Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¹ØµØ±ÙŠ (Face ID Style) === */
        .face-scan-wrapper {
            position: relative; width: 100%; height: 380px; 
            background: #000; border-radius: 30px; 
            overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            margin: 20px 0;
        }
        
        /* Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        #faceCheckVideo {
            width: 100%; height: 100%; object-fit: cover; 
            transform: scaleX(-1); /* Ù…Ø±Ø¢Ø© */
            opacity: 0.8; transition: opacity 0.5s;
        }
        
        /* Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠØ¡ */
        .face-frame {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 220px; height: 220px;
            border-radius: 50%; /* Ø¯Ø§Ø¦Ø±ÙŠ Ù…Ø«Ù„ Face ID */
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 0 999px rgba(0,0,0,0.5); /* ØªØ¹ØªÙŠÙ… Ù…Ø§ Ø­ÙˆÙ„ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© */
            z-index: 10;
            transition: all 0.3s;
        }
        
        .face-frame.active {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 999px rgba(0,0,0,0.7), 0 0 30px rgba(14, 165, 233, 0.5);
        }

        .face-frame.success {
            border-color: #10b981;
            box-shadow: 0 0 0 999px rgba(0,0,0,0.8), 0 0 50px rgba(16, 185, 129, 0.6);
        }

        /* Ø®Ø· Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªØ­Ø±Ùƒ */
        .scan-laser {
            position: absolute; top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, #0ea5e9, transparent);
            animation: scanMove 2s infinite ease-in-out;
            opacity: 0;
        }
        .face-frame.active .scan-laser { opacity: 1; }

        /* Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØªÙ‚Ø¯Ù… (Timer) */
        .progress-ring {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-90deg);
            width: 240px; height: 240px; z-index: 11; pointer-events: none;
        }
        .progress-ring__circle {
            transition: stroke-dashoffset 0.1s linear;
            transform-origin: 50% 50%;
            stroke: #0ea5e9; stroke-width: 6; fill: transparent;
            stroke-dasharray: 700; stroke-dashoffset: 700; /* Ù†Ø¨Ø¯Ø£ Ù…Ø®ÙÙŠ */
            stroke-linecap: round;
        }

        /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ */
        .face-guide-msg {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            text-align: center; color: white; font-weight: 800; font-size: 14px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8); z-index: 20;
        }

        @keyframes scanMove { 0%, 100% { top: 10%; opacity: 0; } 50% { opacity: 1; } 90% { top: 90%; opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Other Styles from original code... (Simplified for brevity) */
        .faculty-title-box { text-align: center; margin-bottom: 20px; }
        .faculty-title-text { font-size: 14px; color: var(--primary-dark); font-weight: bold; background: #e0f2fe; padding: 5px 15px; border-radius: 20px; }
        .student-info-card { background: #f1f5f9; padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: center; }
        .student-info-value { font-weight: 900; color: var(--text-main); font-size: 16px; display: block; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="desktop-blocker">
        <h2>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙÙ‚Ø·</h2>
    </div>

    <div class="bg-image"></div>
    <audio id="successSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>

    <div class="app-card">
        <div id="screenWelcome" class="section active" style="text-align: center;">
            <div style="margin-top: 40px; margin-bottom: 20px;">
                <img src="https://k.top4top.io/p_3615d3vek1.png" style="width: 100px; border-radius: 50%; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
            </div>
            <div class="faculty-title-box"><span class="faculty-title-text">ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ…Ø±ÙŠØ¶ - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø¯Ø©</span></div>
            <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ</h1>
            <p style="color:#64748b;">Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±Ùƒ Ø¨Ø³Ù‡ÙˆÙ„Ø© Ø¹Ø¨Ø± Ø¨ØµÙ…Ø© Ø§Ù„ÙˆØ¬Ù‡</p>
            
            <button onclick="startProcess()" class="btn-main" style="margin-top: 40px;">
                Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ <i class="fa-solid fa-arrow-left"></i>
            </button>
            <p id="modelStatus" style="font-size: 11px; margin-top: 15px; color: #94a3b8;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
        </div>

        <div id="screenDataEntry" class="section" style="text-align: center;">
            <h2 style="margin-top: 20px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
            <p style="margin-bottom: 30px; font-size: 13px; color: #64748b;">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ø±Ù†ÙŠÙ‡</p>
            
            <input type="tel" id="uniID" class="modern-input" placeholder="Ù…Ø«Ø§Ù„: 2024001">
            <div id="dataEntryAlert" style="color: #ef4444; font-size: 12px; display: none; margin-bottom: 10px;"></div>

            <button onclick="handleIdSubmit()" class="btn-main">
                Ø§Ù„ØªØ§Ù„ÙŠ <i class="fa-solid fa-arrow-left"></i>
            </button>
        </div>

        <div id="screenFaceCheck" class="section">
            <h2 style="text-align: center; font-size: 18px;">Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ</h2>
            <div class="student-info-card">
                <span style="font-size: 12px; color: #64748b;">Ø§Ù„Ø·Ø§Ù„Ø¨:</span>
                <span class="student-info-value" id="faceCheckName">--</span>
            </div>

            <div class="face-scan-wrapper">
                <video id="faceCheckVideo" autoplay muted playsinline></video>
                
                <div id="faceFrame" class="face-frame">
                    <div class="scan-laser"></div>
                </div>

                <svg class="progress-ring">
                    <circle class="progress-ring__circle" stroke-width="6" fill="transparent" r="110" cx="120" cy="120"/>
                </svg>

                <div id="faceGuideMsg" class="face-guide-msg">Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div>
            </div>
            
            <button onclick="goToQrScreen()" style="background: none; border: none; color: #94a3b8; width: 100%; cursor: pointer;">ØªØ®Ø·ÙŠ (Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø·)</button>
        </div>

        <div id="screenScanQR" class="section" style="text-align: center;">
            <h2>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h2>
            <p>Ø§Ù…Ø³Ø­ Ø±Ù…Ø² Ø§Ù„Ù€ QR Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</p>
            <div id="qr-reader" style="width: 100%; border-radius: 15px; overflow: hidden; margin-bottom: 20px;"></div>
            <button onclick="startQrScanner()" class="btn-main" style="background: #334155;">ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©</button>
            
            <button onclick="finishAttendance()" class="btn-main" style="margin-top: 10px; background: #10b981;">ØªÙ… Ø§Ù„Ù…Ø³Ø­ (Ù…Ø­Ø§ÙƒØ§Ø©)</button>
        </div>

        <div id="screenSuccess" class="section" style="text-align: center; display: none;">
            <i class="fa-solid fa-circle-check" style="font-size: 80px; color: #10b981; margin-top: 50px;"></i>
            <h1 style="color: #10b981;">ØªÙ… Ø§Ù„Ø­Ø¶ÙˆØ±!</h1>
            <p>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­</p>
            <button onclick="location.reload()" class="btn-main">Ø¹ÙˆØ¯Ø©</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ===
        const CONFIG = {
            sheetApiUrl: "https://script.google.com/macros/s/AKfycbwGzpB4sgb3aC5rPYtmo3C8Pwyq0cLcedEIbacNk56kgmv1aV7OJK1vzofmwszfwzK7/exec"
        };

        // === 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Optimized) ===
        const modelURL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
        let isModelsLoaded = false;

        // ØªØ­Ù…ÙŠÙ„ Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹
        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(modelURL), // Ø£Ø®Ù Ù…ÙˆØ¯ÙŠÙ„ Ù„Ù„ÙƒØ´Ù
            // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ landmark 68 ÙƒØ§Ù…Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨Ø³ÙŠØ·ØŒ Ù„ÙƒÙ† Ø³Ù†Ø­Ù…Ù„Ù‡Ø§ Ù„Ù„Ø¯Ù‚Ø©
            faceapi.nets.faceLandmark68Net.loadFromUri(modelURL) 
        ]).then(() => {
            isModelsLoaded = true;
            document.getElementById('modelStatus').innerText = "âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²";
            document.getElementById('modelStatus').style.color = "#10b981";
        });

        // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„ØªØ¬Ø±Ø¨Ø© (ÙŠØ¬Ø¨ Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ø´ÙŠØª)
        const studentsDB = { "2024001": "Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ", "2024002": "Ø³Ø§Ø±Ø© Ø£Ø­Ù…Ø¯" };

        function switchScreen(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            const screen = document.getElementById(id);
            if(screen) screen.classList.add('active');
        }

        function startProcess() {
            if(!isModelsLoaded) { alert("Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹.. Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"); return; }
            switchScreen('screenDataEntry');
        }

        function handleIdSubmit() {
            const id = document.getElementById('uniID').value;
            // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· (ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ø³ØªØ®Ø¯Ù… studentsDB Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©)
            if(id.length < 3) {
                document.getElementById('dataEntryAlert').style.display = 'block';
                document.getElementById('dataEntryAlert').innerText = "ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­";
                return;
            }
            
            // Ø§Ø³Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§
            const name = studentsDB[id] || "Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯"; 
            
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ¬Ù‡
            startFaceCheck(name, id);
        }

        // ===========================================
        // === ğŸ”¥ Ù†Ø¸Ø§Ù… Ø¨ØµÙ…Ø© Ø§Ù„ÙˆØ¬Ù‡ Ø§Ù„Ù…Ø·ÙˆØ± (Ø³Ø±ÙŠØ¹) ğŸ”¥ ===
        // ===========================================
        
        let faceStream = null;
        let faceInterval = null;
        let progress = 0; // Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù… (0 Ø¥Ù„Ù‰ 100)

        async function startFaceCheck(name, id) {
            document.getElementById('faceCheckName').innerText = name;
            switchScreen('screenFaceCheck');

            const video = document.getElementById('faceCheckVideo');
            const guideMsg = document.getElementById('faceGuideMsg');
            const frame = document.getElementById('faceFrame');
            const circle = document.querySelector('.progress-ring__circle');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯
            progress = 0;
            circle.style.strokeDashoffset = 700; // Ø¯Ø§Ø¦Ø±Ø© ÙØ§Ø±ØºØ©
            frame.classList.remove('active', 'success');

            // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø¯Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø© (VGA) Ù„Ù„Ø³Ø±Ø¹Ø©
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "user",
                        width: { ideal: 640 }, // Ø¯Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø© Ù„Ø¹Ø¯Ù… Ø§Ù„ØªÙ‡Ù†ÙŠØ¬
                        height: { ideal: 480 },
                        frameRate: { ideal: 15 } // 15 ÙØ±ÙŠÙ… ÙƒØ§ÙÙŠØ© Ø¬Ø¯Ø§Ù‹
                    } 
                });
                faceStream = stream;
                video.srcObject = stream;
            } catch (err) {
                alert("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ø§ ØªØ¹Ù…Ù„!");
                return;
            }

            // 2. Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            video.addEventListener('play', () => {
                // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø³Ø±ÙŠØ¹ (TinyFace)
                // inputSize 160 Ø£Ùˆ 224 Ù‡Ùˆ Ø§Ù„Ø£Ø³Ø±Ø¹ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
                const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });

                faceInterval = setInterval(async () => {
                    // ÙƒØ´Ù ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
                    const detection = await faceapi.detectSingleFace(video, options);

                    if (detection) {
                        // === ÙˆØ¬Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ===
                        frame.classList.add('active'); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ù‚
                        guideMsg.innerText = "Ø«Ø¨Øª ÙˆØ¬Ù‡Ùƒ... " + Math.floor(progress) + "%";
                        
                        // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯Ù… (Ø¨Ø³Ø±Ø¹Ø©)
                        progress += 4; // ÙŠÙƒØªÙ…Ù„ ÙÙŠ Ø­ÙˆØ§Ù„ÙŠ 2.5 Ø«Ø§Ù†ÙŠØ© (100 / 4 * 100ms)
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
                        const offset = 700 - (700 * progress / 100);
                        circle.style.strokeDashoffset = offset;

                        if (progress >= 100) {
                            // === ØªÙ… Ø§Ù„Ù†Ø¬Ø§Ø­ ===
                            finishFaceCheck(id, name);
                        }

                    } else {
                        // === Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ¬Ù‡ ===
                        frame.classList.remove('active');
                        guideMsg.innerText = "Ø¶Ø¹ ÙˆØ¬Ù‡Ùƒ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©";
                        // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¨Ø·Ø¡ Ø¥Ø°Ø§ ØªØ­Ø±Ùƒ
                        if(progress > 0) progress -= 5;
                        if(progress < 0) progress = 0;
                        circle.style.strokeDashoffset = 700 - (700 * progress / 100);
                    }
                }, 100); // Ø§Ù„ÙØ­Øµ ÙƒÙ„ 100 Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©
            });
        }

        function finishFaceCheck(id, name) {
            // Ø¥ÙŠÙ‚Ø§Ù ÙƒÙ„ Ø´ÙŠØ¡
            clearInterval(faceInterval);
            const frame = document.getElementById('faceFrame');
            const guideMsg = document.getElementById('faceGuideMsg');
            const sound = document.getElementById('successSound');

            // ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø£Ø®Ø¶Ø±
            frame.classList.remove('active');
            frame.classList.add('success');
            guideMsg.innerText = "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­! âœ…";
            sound.play();

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
            // sendDataToSheet(id, name)...

            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
            setTimeout(() => {
                if(faceStream) faceStream.getTracks().forEach(t => t.stop());
                goToQrScreen();
            }, 1000);
        }

        function goToQrScreen() {
            switchScreen('screenScanQR');
        }

        function startQrScanner() {
            // Ù‡Ù†Ø§ ØªØ¶Ø¹ ÙƒÙˆØ¯ ØªØ´ØºÙŠÙ„ html5-qrcode
            const html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10 }, 
            (decodedText) => {
                html5QrCode.stop();
                finishAttendance();
            });
        }

        function finishAttendance() {
            switchScreen('screenSuccess');
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        // Service Worker (Ù„Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø³Ø±Ø¹Ø©)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Failed'));
            });
        }
    </script>
</body>
</html>
