<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù†Ø¸Ø§Ù… ÙƒØ´Ù Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø·ÙˆØ± - ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ…Ø±ÙŠØ¶</title>
    
    <meta property="og:title" content="Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø¯Ø© - ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ…Ø±ÙŠØ¶">
    <meta property="og:description" content="Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ.">
    <meta property="og:image" content="https://k.top4top.io/p_3615d3vek1.png">
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Outfit:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        /* === (Ø¬Ù…ÙŠØ¹ ØªÙ†Ø³ÙŠÙ‚Ø§ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù‡Ù†Ø§ - ØªÙ… Ø§Ù„Ø§Ù‚ØªØµØ§Ø± ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ„ÙƒÙ†Ù‡Ø§ Ù…Ø¶Ù…Ù†Ø©) === */
        :root { --primary: #0ea5e9; --primary-dark: #0284c7; --text-main: #1e293b; --text-sub: #64748b; --glass-bg: rgba(255, 255, 255, 0.95); --danger: #ef4444; --success: #10b981; --warning: #f59e0b; }
        /* (Ø¨Ù‚ÙŠØ© ØªÙ†Ø³ÙŠÙ‚Ø§ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ©...) */
        
        /* === ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆÙ„Ø§Ø°ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© === */
        .cam-wrapper {
            width: 240px; height: 240px; margin: 20px auto;
            border-radius: 50%; border: 6px solid #e2e8f0;
            position: relative; overflow: hidden; background: black;
            transform: scaleX(-1); transition: 0.3s;
        }
        .cam-wrapper video { width: 100%; height: 100%; object-fit: cover; }
        .timer-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 80px; font-weight: 900; color: white;
            text-shadow: 0 4px 20px black; pointer-events: none;
            z-index: 10; display: none;
        }
        .status-ok { border-color: #10b981 !important; box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); }
        .status-wait { border-color: #f59e0b !important; box-shadow: 0 0 30px rgba(245, 158, 11, 0.5); }
        .status-err { border-color: #ef4444 !important; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
        /* (Ù†Ù‡Ø§ÙŠØ© ØªÙ†Ø³ÙŠÙ‚Ø§ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ©...) */
    </style>
</head>
<body>
    <div id="desktop-blocker">
        <i class="fa-solid fa-mobile-screen-button" style="font-size:50px; margin-bottom:20px;"></i>
        <h2 style="margin-bottom:10px">Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙˆØµÙˆÙ„ ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡</h2>
        <p>Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù…Ù† Ù‡ÙˆØ§ØªÙ Android Ùˆ iPhone Ø§Ù„Ø°ÙƒÙŠØ©.</p>
    </div>

    <div class="bg-image"></div>
    <audio id="successSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>
    <audio id="clickSound" src="https://www.soundjay.com/buttons/sounds/button-16.mp3"></audio>
    <audio id="beepSound" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3"></audio>

    <div class="app-card">
        <div class="card-banner"></div>
        <div id="adminBadge" class="admin-badge"><i class="fa-solid fa-user-shield"></i> ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù…ÙØ¹Ù„</div>

        <div class="card-body">
            
            <div class="hero-icon-wrapper" id="heroIconWrapper">
                <img src="https://k.top4top.io/p_3615d3vek1.png" class="hero-img" id="heroImage">
                <div class="status-icon-container" id="statusIconContainer">
                    <i class="fa-solid fa-user-nurse hero-icon" id="statusIcon"></i>
                </div>
            </div>
            
            <div class="info-bar">
                <div class="info-pill"><i class="fa-regular fa-clock"></i> <span id="currentTime">--:--:--</span></div>
                <div class="info-pill"><i class="fa-regular fa-calendar"></i> <span id="currentDate">--/--/----</span></div>
            </div>

            <div class="card-body-content">
                
                <div id="screenWelcome" class="section active">
                    <div style="position: relative; z-index: 2;">
                        <button onclick="safeClick(this, () => startProcess(false))" class="btn-main" id="mainActionBtn">
                            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± <i class="fa-solid fa-fingerprint"></i>
                        </button>
                        </div>
                </div>

                <div id="screenAdminLogin" class="section">
                    </div>

                <div id="screenLoading" class="section">
                    </div>
                
                
                <div id="screenFaceAuth" class="section">
                    <h1 style="font-size:20px; margin-top:5px;">Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø­ÙŠÙˆÙŠ (Face-ID)</h1>
                    <p style="margin-bottom: 25px;">ÙŠØ¬Ø¨ ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØ¬Ù‡ ÙˆØ¥Ø¬Ø±Ø§Ø¡ Ø­Ø±ÙƒØ© Ø§Ù„Ø§Ù„ØªÙØ§Øª.</p>

                    <div id="camBorder" class="cam-wrapper">
                        <video id="videoElement" autoplay muted playsinline></video>
                        <div class="timer-overlay" id="camTimer">3</div>
                    </div>
                    
                    <h3 id="faceStatusText" style="font-weight: 800; color: var(--primary); font-size: 18px; min-height: 27px; margin-bottom: 15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„...</h3>
                    
                    <button onclick="cancelFaceAuth()" class="btn-secondary" style="background: #fef2f2; color: #b91c1c; border-color: #fecaca;">
                        Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© <i class="fa-solid fa-arrow-right-from-bracket fa-flip-horizontal"></i>
                    </button>

                    <div id="filterResultDisplay" style="font-size: 13px; color: #f59e0b; font-weight: 700; margin-top: 10px;"></div>
                </div>
                <div id="screenDataEntry" class="section">
                    <div class="circular-timer">
                        </div>
                    <button type="button" onclick="handleIdSubmit()" class="btn-main" id="nextStepBtn" style="margin-top:20px;">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fa-solid fa-arrow-left"></i></button>
                </div>
                
                <div id="screenScanQR" class="section">
                    </div>

                <div id="screenSuccess" class="section">
                    </div>

                <div id="screenError" class="section">
                    </div>

            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        // ==========================================
        // âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙŠØ¯ÙˆÙŠØ§Ù‹)
        // ==========================================
        const CONFIG = {
            // ğŸ”´ Ù‡Ø§Ù…: Ù‡Ø°Ø§ Ù‡Ùˆ Ø±Ø§Ø¨Ø· DEPLOY Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡
            sheetApiUrl: "https://script.google.com/macros/s/AKfycbyKFRtSui8dfelJxTDl8T5jV1EMESlvhPht2Qqb2VU6tKtr3TFM1oGCT5kK-bkX26ZKLA/exec",
            adminPassword: "RYADA",
            gps: { targetLat: 30.38583, targetLong: 30.48888, allowedDistanceKm: 1.5 },
            modelsUrl: 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/models'
            MAX_FACE_CHECK_TIME_SEC: 10 // â±ï¸ Ù…Ø¯Ø© Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø± (Filter Mode)
        };
        
        // (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©...)
        const LOCAL_STORAGE_DB_KEY = "offline_students_db_v2";
        const DOCTOR_MODE_KEY = "is_doctor_bypass_enabled";
        const DATA_ENTRY_TIMEOUT_SEC = 20;
        const TIMEOUT_BLOCK_KEY = "timeout_blocked_forever_v47_" + new Date().toLocaleDateString('en-GB');
        const SESSION_END_TIME_KEY = "data_entry_deadline_v2";
        const MAX_ATTEMPTS = 3;
        const ATTEMPTS_KEY = "daily_attempts_v47_" + new Date().toLocaleDateString('en-GB');
        const storageKey = "nursing_final_secure_v47";
        
        let studentsDB = {};
        let userIP = "Unknown";
        let geo_watch_id;
        let countdownInterval;
        let html5QrCode;
        let currentAbortController = null;
        let sessionEndTime = 0;
        let processIsActive = false;
        let isProcessingClick = false;
        
        // ğŸ›¡ï¸ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆÙ„Ø§Ø°ÙŠ
        let attendanceData = { 
            uniID: null, name: null, code: null, 
            lat: null, lng: null, 
            vector: null, deviceId: null, 
            faceStatus: "N/A" 
        }; 
        let videoStream = null;
        let lastNoseX = 0, lastNoseY = 0;
        let faceCheckInterval = null;
        let faceCheckTimeoutTimer = null;
        
        // (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©: subjectsData)
        const subjectsData = {
            "first_year": ["ØªÙ…Ø±ÙŠØ¶ Ø¨Ø§Ù„ØºÙŠÙ† 1 Ù†Ø¸Ø±Ù‰", "ØªÙ…Ø±ÙŠØ¶ Ø¨Ø§Ù„ØºÙŠÙ† 1 Ø¹Ù…Ù„Ù‰", "Ø§Ù†Ø§ØªÙˆÙ…Ù‰ Ù†Ø¸Ø±Ù‰", "Ø§Ù†Ø§ØªÙˆÙ…Ù‰ Ø¹Ù…Ù„Ù‰", "ØªÙ‚ÙŠÙŠÙ… ØµØ­Ù‰ Ù†Ø¸Ø±Ù‰", "ØªÙ‚ÙŠÙŠÙ… ØµØ­Ù‰ Ø¹Ù…Ù„Ù‰", "Ù…ØµØ·Ù„Ø­Ø§Øª Ø·Ø¨ÙŠØ©", "ÙØ³ÙŠÙˆÙ„ÙˆØ¬Ù‰", "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª"],
            "second_year": ["ØªÙ…Ø±ÙŠØ¶ Ø¨Ø§Ù„ØºÙŠÙ† 1 Ù†Ø¸Ø±Ù‰", "ØªÙ…Ø±ÙŠØ¶ Ø¨Ø§Ù„ØºÙŠÙ† 1 Ø¹Ù…Ù„Ù‰", "ØªÙ…Ø±ÙŠØ¶ Ø­Ø§Ù„Ø§Øª Ø­Ø±Ø¬Ø© 1 Ù†Ø¸Ø±Ù‰", "ØªÙ…Ø±ÙŠØ¶ Ø­Ø§Ù„Ø§Øª Ø­Ø±Ø¬Ø© 1 Ø¹Ù…Ù„Ù‰", "Ø§Ù…Ø±Ø§Ø¶ Ø¨Ø§Ø·Ù†Ø©", "Ø¨Ø§Ø«ÙˆÙ„ÙˆØ¬Ù‰", "Ø¹Ù„Ù… Ø§Ù„Ø£Ø¯ÙˆÙŠØ©", "Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©"]
        };


        // ğŸ›¡ï¸ Ø¯Ø§Ù„Ø© Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
        function getDeviceId() {
            let id = localStorage.getItem('student_device_id');
            if (!id) {
                id = 'DEV-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
                localStorage.setItem('student_device_id', id);
            }
            return id;
        }

        // ----------------------------------------------------
        // ğŸš¨ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ù…Ù† ÙƒÙˆØ¯Ùƒ) - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ù„Ø±Ø¨Ø·
        // ----------------------------------------------------
        
        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ©
        function showError(msg, isPermanent = false) { 
            if(countdownInterval) clearInterval(countdownInterval); 
            document.getElementById('errorMsg').innerHTML = msg; 
            const retryBtn = document.getElementById('retryBtn'); 
            if(isPermanent) retryBtn.style.display = 'none'; 
            else { 
                retryBtn.style.display = 'inline-block'; 
                retryBtn.onclick = function() { location.reload(); }; 
            } 
            switchScreen('screenError'); 
            if(navigator.vibrate) navigator.vibrate(300); 
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø£ØµÙ„ÙŠØ©
        async function goBackToWelcome() { 
            playClick(); 
            if (geo_watch_id) navigator.geolocation.clearWatch(geo_watch_id); 
            if(countdownInterval) clearInterval(countdownInterval); 
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆÙ„Ø§Ø°ÙŠ
            if (faceCheckInterval) clearInterval(faceCheckInterval);
            if (faceCheckTimeoutTimer) clearTimeout(faceCheckTimeoutTimer);
            if(videoStream) videoStream.getTracks().forEach(t => t.stop());

            await stopCameraSafely(); 
            // (Ø¨Ù‚ÙŠØ© ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ...)
            sessionStorage.removeItem(SESSION_END_TIME_KEY); 
            // (Ø¨Ù‚ÙŠØ© ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ...)
            processIsActive = false; releaseWakeLock(); 
            document.getElementById('uniID').value = ''; 
            document.getElementById('startScanCard').style.display = 'flex'; 
            hideConnectionLostModal(); switchScreen('screenWelcome'); 
        }

        // Ø¯Ø§Ù„Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£ØµÙ„ÙŠØ©
        function addKey(num) { playClick(); const i = document.getElementById('uniID'); if(i.value.length<10) i.value+=num; }
        function backspaceKey() { playClick(); const i = document.getElementById('uniID'); i.value=i.value.slice(0,-1); }
        function clearKey() { playClick(); document.getElementById('uniID').value=''; }

        // Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù€ QR Ø§Ù„Ø£ØµÙ„ÙŠØ©
        async function stopCameraSafely() { 
            if(html5QrCode && html5QrCode.isScanning) { try { await html5QrCode.stop(); } catch(e) {} } 
            document.getElementById('qr-reader').style.display = 'none'; 
            releaseWakeLock(); 
        }


        // ----------------------------------------------------
        // ğŸš¨ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆÙ„Ø§Ø°ÙŠ
        // ----------------------------------------------------
        
        // 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© handleIdSubmit() - ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¬Ù‡Ø©
        async function handleIdSubmit() {
            playClick();
            let rawId = document.getElementById('uniID').value.trim();
            const uniIdVal = convertArabicToEnglish(rawId);
            const alertBox = document.getElementById('dataEntryAlert');

            if (!uniIdVal || Object.keys(studentsDB).length === 0 || !studentsDB[uniIdVal]) { 
                alertBox.innerText = "âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."; 
                alertBox.style.display = 'block'; 
                if(navigator.vibrate) navigator.vibrate(300); 
                return; 
            }
            
            const studentName = studentsDB[uniIdVal];
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
            attendanceData.uniID = uniIdVal; 
            attendanceData.name = studentName;
            attendanceData.deviceId = getDeviceId(); // ğŸ›¡ï¸ Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
            attendanceData.faceStatus = "Failed (Timeout)"; // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            
            if(countdownInterval) clearInterval(countdownInterval); 
            
            // ğŸš¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆÙ„Ø§Ø°ÙŠ
            switchScreen('screenFaceAuth'); 
            openCameraForFaceAuth(); 
            playSuccess();
        }

        // 2. Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆÙ„Ø§Ø°ÙŠ
        async function openCameraForFaceAuth() {
            const videoEl = document.getElementById('videoElement');
            const statusText = document.getElementById('faceStatusText');
            await stopCameraSafely(); 

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                videoStream = stream;
                videoEl.srcObject = stream;
                statusText.innerText = "Ø§Ø«Ø¨Øª Ù…ÙƒØ§Ù†Ùƒ ØªÙ…Ø§Ù…Ø§Ù‹.. Ù„Ø§ ØªØªØ­Ø±Ùƒ";
                
                // Ø¨Ø¯Ø¡ Ù…Ø¤Ù‚Øª Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© (Filter Mode)
                faceCheckTimeoutTimer = setTimeout(() => {
                    if(faceCheckInterval) clearInterval(faceCheckInterval);
                    
                    document.getElementById('faceStatusText').innerText = "âš ï¸ Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚! Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©...";
                    document.getElementById('camBorder').className = "cam-wrapper status-err";
                    document.getElementById('filterResultDisplay').innerText = "Ø§Ù„Ù†ØªÙŠØ¬Ø©: ÙØ´Ù„ (Timeout)";
                    
                    submitFinalData(); // Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©
                }, CONFIG.MAX_FACE_CHECK_TIME_SEC * 1000);

                runLivenessCheck();
            } catch (e) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
                cancelFaceAuth();
            }
        }

        // 3. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø­ÙŠÙˆÙŠ
        function runLivenessCheck() {
            const videoEl = document.getElementById('videoElement');
            const border = document.getElementById('camBorder');
            const status = document.getElementById('faceStatusText');
            const timer = document.getElementById('camTimer');
            
            let step = 0; let count = 3; let counting = false; let timerInt = null;
            const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 160, scoreThreshold: 0.5 });

            faceCheckInterval = setInterval(async () => {
                if(videoEl.paused || videoEl.ended) return;

                const det = await faceapi.detectSingleFace(videoEl, options)
                                         .withFaceLandmarks().withFaceDescriptor().withFaceExpressions();

                if (det) {
                    const nose = det.landmarks.getNose()[0]; const jaw = det.landmarks.getJawOutline();
                    const ratio = Math.abs(nose.x - jaw[0].x) / Math.abs(nose.x - jaw[16].x);
                    const moveDist = Math.sqrt(Math.pow(nose.x - lastNoseX, 2) + Math.pow(nose.y - lastNoseY, 2));
                    lastNoseX = nose.x; lastNoseY = nose.y;
                    const isStableFace = det.expressions.neutral > 0.7; const isNotMoving = moveDist < 10; 

                    if (step === 0) {
                        if (ratio > 0.7 && ratio < 1.3 && isStableFace && isNotMoving) {
                            border.className = "cam-wrapper status-ok";
                            if (!counting) { 
                                counting = true; 
                                document.getElementById('filterResultDisplay').innerText = "Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
                                timerInt = setInterval(() => {
                                    count--; 
                                    if (count <= 0) {
                                        clearInterval(timerInt); 
                                        attendanceData.vector = Array.from(det.descriptor); // Ø­ÙØ¸ Ø§Ù„Ø¨ØµÙ…Ø©
                                        step = 1; 
                                        document.getElementById('sndBeep').play();
                                        border.className = "cam-wrapper status-wait";
                                        status.innerText = "â¬…ï¸ Ø§Ù„Ø¢Ù† Ø§Ù„ØªÙØª Ù„Ù„ÙŠØ³Ø§Ø±"; status.style.color = "#f59e0b";
                                    }
                                }, 1000);
                            }
                        }
                    } else if (step === 1) {
                        if (ratio < 0.6) { // Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§Ù„ØªÙØ§Øª
                            clearInterval(faceCheckInterval);
                            clearTimeout(faceCheckTimeoutTimer); 
                            attendanceData.faceStatus = "Passed"; 
                            document.getElementById('filterResultDisplay').innerText = "Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ù†Ø¬Ø§Ø­ (Liveness Check)";
                            submitFinalData();
                        }
                    }
                } 
            }, 500);
        }
        
        // 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„ÙØ­Øµ Ø§Ù„ÙÙˆÙ„Ø§Ø°ÙŠ
        function submitFinalData() {
            if (faceCheckInterval) clearInterval(faceCheckInterval);
            if (faceCheckTimeoutTimer) clearTimeout(faceCheckTimeoutTimer);
            if(videoStream) videoStream.getTracks().forEach(t => t.stop());
            
            // ğŸš¨ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø´Ø§Ø´Ø© Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ (screenScanQR)
            switchScreen('screenScanQR');
        }

        // 5. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        function cancelFaceAuth() {
            if (faceCheckInterval) clearInterval(faceCheckInterval);
            if (faceCheckTimeoutTimer) clearTimeout(faceCheckTimeoutTimer);
            if(videoStream) videoStream.getTracks().forEach(t => t.stop());
            switchScreen('screenDataEntry');
        }


        // 6. Ø§Ù„Ø¯Ø§Ù„Ø© submitToGoogle() - ØªÙ… ØªØºÙŠÙŠØ± ØµÙŠØºØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ JSON
        async function submitToGoogle() {
            // (ØªÙ… Ù†Ù‚Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø¯Ø§Ù„Ø© Ù‡Ù†Ø§)
            playClick();
            const btn = document.getElementById('submitBtn');
            const originalText = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ± <i class='fa-solid fa-paper-plane'></i>";
            const selectedSubject = document.getElementById('subjectSelect').value; 
            const sessionPassVal = document.getElementById('sessionPass').value;

            // (ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒÙ…Ø§ Ù‡Ùˆ)
            if(!attendanceData.uniID || !sessionPassVal || !selectedSubject) { showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆÙ…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯.", 3000, '#f59e0b'); return; }

            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...'; btn.disabled = true;
            const isOnline = await checkRealConnection(); 
            if (!isOnline) { btn.innerHTML = originalText; btn.disabled = false; showConnectionLostModal(); return; }
            
            // ğŸ’¡ Ø­Ø²Ù…Ø© Ø¨ÙŠØ§Ù†Ø§Øª JSON Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            const payload = {
                action: "register",
                id: attendanceData.uniID,
                name: attendanceData.name,
                subject: selectedSubject,
                code: `${attendanceData.code} (QR: ${sessionPassVal})`,
                ip: userIP,
                deviceId: attendanceData.deviceId,
                faceVector: attendanceData.vector ? attendanceData.vector.join(',') : 'N/A',
                faceStatus: attendanceData.faceStatus, // Passed/Failed
                gpsLat: attendanceData.lat,
                gpsLng: attendanceData.lng,
                timestamp: new Date().toISOString()
            };
            
            try {
                 // ğŸš¨ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨ØµÙŠØºØ© JSON
                await fetch(CONFIG.sheetApiUrl, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                
                // (Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ø¬Ø§Ø­ ÙƒÙ…Ø§ Ù‡Ùˆ)
                switchScreen('screenSuccess'); playSuccess(); confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#0ea5e9', '#10b981'] });
                processIsActive = false; releaseWakeLock();
            } catch (error) { btn.innerHTML = originalText; btn.disabled = false; showConnectionLostModal(); }
        }

        // (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ù† ÙƒÙˆØ¯Ùƒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‡Ù†Ø§)
        // ... (ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ù‚Ø§Ø¡ ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø§Ù„Ø£Ø®Ø±Ù‰ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„ÙˆÙƒ)
        // ... (Ù…Ø«Ù„ updateUIForMode, startCountdown, isMobileDevice, checkAdminPassword, Ø¥Ù„Ø®)

    </script>
</body>
</html>